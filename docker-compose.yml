services:
  booker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: booker
    restart: unless-stopped
    ports:
      - "${APP_PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3000}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - AUTH_TRUST_HOST=true
      - LIBRARY_PATH=/data
      - BOOKS_PATH=/data/books
      - COVERS_PATH=/data/covers
      - CALIBRE_MODE=remote
      - CALIBRE_API_URL=http://calibre:8080
    volumes:
      - ${DATA_PATH:-./data}:/data
    depends_on:
      calibre:
        condition: service_healthy
    networks:
      - booker-network

  calibre:
    build:
      context: .
      dockerfile: Dockerfile.calibre
    container_name: booker-calibre
    restart: unless-stopped
    ports:
      - "${CALIBRE_PORT:-8081}:8080"
    environment:
      - CALIBRE_LIBRARY_PATH=/data/books
    volumes:
      - ${DATA_PATH:-./data}:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 3
    networks:
      - booker-network

networks:
  booker-network:
    driver: bridge
